name: Build Flet APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- ТВОЯ ИДЕАЛЬНАЯ НАСТРОЙКА СИСТЕМЫ ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Python deps
        run: |
          pip install flet
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Flutter doctor
        run: flutter doctor -v

      # --- НАША РУЧНАЯ СБОРКА (ТЕПЕРЬ РАБОЧАЯ) ---
      - name: Create Flutter App
        run: flutter create android_app

      - name: Copy Python files
        run: |
          cp dashboard_flet.py android_app/
          cp telegram_api.py android_app/
          cp requirements.txt android_app/

      - name: Configure pubspec.yaml
        run: |
          cd android_app
          flutter pub add flet
          flutter pub add python_channel

      - name: Create main.dart (ИСПРАВЛЕНО!)
        run: |
          echo '''
          import 'package:flet/flet.dart';
          import 'package:flutter/material.dart';
          import 'package:python_channel/python_channel.dart';

          void main() async {
            await Flet.setupDesktop();
            runApp(const MyApp());
          }

          class MyApp extends StatelessWidget {
            const MyApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                home: FletPythonApp(
                  pythonChannel: PythonChannel(
                    script: "dashboard_flet.py",
                  ),
                ),
              );
            }
          }
          ''' > android_app/lib/main.dart

      # --- ЗАПУСКАЕМ НАСТОЯЩУЮ СБОРКУ ---
      - name: Build APK
        run: |
          cd android_app
          flutter build apk

      # --- ОТДАЕМ ТЕБЕ ГОТОВЫЙ APK ---
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: android_app/build/app/outputs/flutter-apk/app-release.apk
